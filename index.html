<!DOCTYPE html>
<html>
<head>
	<title>在线通讯</title>
	<meta charset="utf-8">
	 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" type="text/css" href="./static/css/bootstrap.min.css">
</head>
<body>
<div id="app">
	<div class="container">
		<!-- 登录 -->
		<div id="login">
			<template v-if="!islogin">
			<form style="margin-top: 100px;">
			  <div class="form-group">
			    <label for="exampleInputEmail1">邮箱</label>
			    <input type="email" class="form-control" id="exampleInputEmail1" placeholder="Email" v-model="email">
			  </div>
			  <div class="form-group">
			    <label for="exampleInputPassword1">密码</label>
			    <input type="password" class="form-control" id="exampleInputPassword1" placeholder="Password" v-model="password">
			  </div>
			  
			  <a type="submit" class="btn btn-default" @click="login">登录</a>
			</form>
			</template>
		</div>
		<template v-if="islogin">
			<div class="row">
				<!-- 好友列表 -->
				<div id="friends" class="col-sm-2">
					<div class="item" v-for="(friend,index) in friends" :key="index">
						<dl>
							<dt style="cursor: pointer;" @click="select(friend)">{{friend.nickname}}</dt>
						</dl>
					</div>
				</div>
				<!-- 消息发送窗口 -->
				<div id="messages" class="col-sm-10">
					<h1>{{temp.nickname}}</h1>
					<div class="form-group">
					    <label for="exampleInputContent">聊天内容</label>
					    <textarea class="form-control" v-model="content" placeholder="请输入内容"></textarea>
					  </div>
					<div class="form-group">
						<a type="submit" class="btn btn-default" @click="submit">提交</a>
					</div>
				</div>
			</div>
				
		</template>
		
	</div>
</div>
<script type="text/javascript" src="./static/js/vue.min.js"></script>
<script type="text/javascript" src="./static/js/ws.js"></script>
<script type="text/javascript">

	function getCli(uri){
		return new Promise(function(resolve,reject){
			fetch(uri).then(function(res){
				return res.json()
			}).then(function(res){
				resolve(res)
			})
		})
	}
	function postCli(uri,data){
		return new Promise(function(resolve,reject){
			fetch(uri,{method:"post",body:data}).then(function(res){
				return res.json()
			}).then(function(res){
				resolve(res)
			})
		})
	}
	var app = new Vue({
		el:"#app",
		data(){
			return {
				islogin :false,
				email:'1711861430@qq.com',
				password:'',
				otherid:"8",
				content:'',
				friends:[],
				temp:{}
			}
		},
		created(){
			var uid = localStorage.getItem("uid");
			var self = this;
			if(uid) {
				self.islogin = true;
				var formdata = new FormData();
					formdata.append("uid",uid)
				postCli("api/user/friends",formdata).then(function(res){
					if(res.code == 200) {
						self.friends = res.data;
					} else {
						self.friends = [];
					}
				})
			} else {
				self.islogin = false;
			}

		},
		methods:{
			login(){
				var self = this
				var formdata = new FormData();
					formdata.append("email",self.email)
					formdata.append("password",self.email)
				postCli("api/login",formdata).then(function(res){
					if (res.code == 200) {
						self.islogin = true;
						self.friends = res.data.friends;
						localStorage.setItem("uid",res.data.user.id);
					} else {
						console.log("登录失败")
					}
				})
				
			},
			select(friend){
				this.temp = friend
			},
			submit(){
				var self = this
				var obj = {}
					obj.type = "message"
					obj.content = self.content
					obj.fromid = parseInt(localStorage.getItem("uid"))
					obj.toid =  self.temp.id
				ws.send(JSON.stringify(obj))
			}
		}
	})

	//查询在线用户
	setInterval(function(){
		// ws.send(JSON.stringify({type:"online"}))
		ws.send(JSON.stringify({type:"pong"}));
	},1000 * 55)
</script>
</body>
</html>